<!DOCTYPE html>
<html lang="en">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<head>
  <meta charset="UTF-8">
  <title>Ticket Confirmed | MyTickitSpot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    body{margin:0;font-family:Arial,sans-serif;background:#f4f6fb;}
    .ticket-box{max-width:420px;background:#fff;margin:50px auto;padding:25px;border-radius:10px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.1);}
    h2{color:green;margin-bottom:10px;}
    .ticket-info{text-align:left;margin-top:15px;font-size:14px;}
    .ticket-info p{margin:6px 0;}
    .qr img{width:160px;margin:20px 0;}
    .btn{display:block;margin-top:12px;padding:12px;background:#4f46e5;color:#fff;border:none;border-radius:5px;cursor:pointer;width:100%;font-size:15px;}
    .success{font-size:13px;color:#555;margin-top:8px;}
  </style>
</head>
<body>

<div class="ticket-box">
  <h2>âœ… Payment Successful</h2>
  <p class="success">Your ticket has been confirmed</p>

  <div class="ticket-info">
    <p><b>Booking ID:</b> <span id="bookingId"></span></p>
    <p><b>Event:</b> <span id="event"></span></p>
    <p><b>Name:</b> <span id="name"></span></p>
    <p><b>Email:</b> <span id="email"></span></p>
    <p><b>Quantity:</b> <span id="qty"></span></p>
    <p><b>Total Payment:</b> â‚¹<span id="total"></span></p>
    <p><b>Status:</b> Confirmed</p>
  </div>

  <div class="qr">
    <img id="qrCode" src="" alt="QR Code">
  </div>

  <button class="btn" onclick="downloadTicket()">Download Ticket (PDF)</button>
  <button class="btn" onclick="goHome()">Back to Dashboard</button>
  <p class="success">ðŸ“© Ticket sent to Email & WhatsApp</p>
</div>

<script>
  const bookingId = localStorage.getItem("lastBookingId");
  const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
  const booking = bookings.find(b => b.bookingId === bookingId);

  if(!booking) window.location.href="attendee-dashboard.html";

  document.getElementById("bookingId").innerText = booking.bookingId;
  document.getElementById("event").innerText = booking.eventName + " by " + booking.vendor;
  document.getElementById("name").innerText = booking.attendee;
  document.getElementById("email").innerText = booking.email;
  document.getElementById("qty").innerText = booking.qty;
  document.getElementById("total").innerText = booking.total;

  // QR generation using Google API
  document.getElementById("qrCode").src = "https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=" + booking.bookingId;


async function downloadTicket() {
  const { jsPDF } = window.jspdf;

  const doc = new jsPDF();

  // Add Title
  doc.setFontSize(22);
  doc.text("ðŸŽŸ MyTickitSpot Ticket", 20, 20);

  doc.setFontSize(14);
  doc.text(`Booking ID: ${booking.bookingId}`, 20, 40);
  doc.text(`Event: ${booking.eventName} by ${booking.vendor}`, 20, 50);
  doc.text(`Name: ${booking.attendee}`, 20, 60);
  doc.text(`Email: ${booking.email}`, 20, 70);
  doc.text(`Quantity: ${booking.qty}`, 20, 80);
  doc.text(`Total Payment: â‚¹${booking.total}`, 20, 90);
  doc.text(`Status: Confirmed`, 20, 100);

  // Add QR Code Image
  const qrUrl = document.getElementById("qrCode").src;
  const imgData = await getImageData(qrUrl);
  doc.addImage(imgData, 'PNG', 150, 20, 40, 40);

  // Save PDF
  doc.save(`${booking.bookingId}.pdf`);
}

// Convert Image URL to Data URL for jsPDF
function getImageData(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.src = url;
    img.onload = function() {
      const canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0);
      resolve(canvas.toDataURL("image/png"));
    }
  });
}



  function goHome(){
    window.location.href="dashboard.html";
  }
</script>

</body>
</html>
