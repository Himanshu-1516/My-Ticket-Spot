<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vendor Bookings | MyTickitSpot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <style>
    body { margin:0;font-family:Arial,sans-serif;background:#f4f6fb; }
    .sidebar { width:230px;height:100vh;background:#111827;position:fixed;color:#fff;padding:20px; }
    .sidebar h2 { text-align:center;margin-bottom:30px; }
    .sidebar a { display:block;color:#c7d2fe;text-decoration:none;padding:12px;border-radius:6px;margin-bottom:10px;font-size:14px; }
    .sidebar a:hover, .sidebar a.active { background:#1f2937;color:#fff; }
    .main { margin-left:250px;padding:25px; }
    h1{margin-bottom:20px;}
    table { width:100%; background:#fff; border-collapse:collapse; border-radius:10px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.08); }
    th, td { padding:14px; border-bottom:1px solid #eee; font-size:14px; text-align:left; }
    th { background:#f1f5f9; }
    .btn { padding:6px 10px; border:none; border-radius:4px; font-size:12px; cursor:pointer; background:#4f46e5; color:#fff; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>ðŸŽ« Vendor</h2>
  <a href="vendor-dashboard.html">Dashboard</a>
  <a href="create-event.html">Create Event</a>
  <a href="vendor-bookings.html" class="active">Bookings</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<div class="main">
  <h1>My Event Bookings</h1>

  <table id="vendorBookingsTable">
    <tr>
      <th>Booking ID</th>
      <th>Event</th>
      <th>Attendee</th>
      <th>Email</th>
      <th>Tickets</th>
      <th>Total</th>
      <th>Action</th>
    </tr>
  </table>
</div>

<script>
const user = JSON.parse(localStorage.getItem("loggedInUser"));
if(!user || user.role !== "vendor") window.location.href="login.html";

function logout() {
  localStorage.removeItem("loggedInUser");
  window.location.href="login.html";
}

const bookings = JSON.parse(localStorage.getItem("bookings")) || [];
const vendorBookings = bookings.filter(b => b.vendor === user.name);

const table = document.getElementById("vendorBookingsTable");
vendorBookings.forEach(b=>{
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${b.bookingId}</td>
    <td>${b.eventName}</td>
    <td>${b.attendee}</td>
    <td>${b.email}</td>
    <td>${b.qty}</td>
    <td>â‚¹${b.total}</td>
    <td>
      <button class="btn" onclick="downloadTicket('${b.bookingId}')">Download PDF</button>
    </td>
  `;
  table.appendChild(tr);
});

// PDF Download function (reuse jsPDF code)
async function downloadTicket(id){
  const booking = vendorBookings.find(b=>b.bookingId===id);
  if(!booking) return alert("Booking not found!");
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(22);
  doc.text("ðŸŽŸ MyTickitSpot Ticket", 20, 20);
  doc.setFontSize(14);
  doc.text(`Booking ID: ${booking.bookingId}`, 20, 40);
  doc.text(`Event: ${booking.eventName} by ${booking.vendor}`, 20, 50);
  doc.text(`Attendee: ${booking.attendee}`, 20, 60);
  doc.text(`Email: ${booking.email}`, 20, 70);
  doc.text(`Quantity: ${booking.qty}`, 20, 80);
  doc.text(`Total Payment: â‚¹${booking.total}`, 20, 90);
  doc.text(`Status: Confirmed`, 20, 100);

  // QR Code
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${booking.bookingId}`;
  const imgData = await getImageData(qrUrl);
  doc.addImage(imgData,'PNG',150,20,40,40);
  doc.save(`${booking.bookingId}.pdf`);
}

// Convert Image to DataURL
function getImageData(url){
  return new Promise(resolve=>{
    const img=new Image();
    img.crossOrigin="anonymous";
    img.src=url;
    img.onload=function(){
      const canvas=document.createElement("canvas");
      canvas.width=img.width;
      canvas.height=img.height;
      const ctx=canvas.getContext("2d");
      ctx.drawImage(img,0,0);
      resolve(canvas.toDataURL("image/png"));
    }
  });
}
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
